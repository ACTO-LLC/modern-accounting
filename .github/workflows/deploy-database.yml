name: Deploy Database Schema

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run — generate diff script only, do not deploy'
        required: true
        default: true
        type: boolean
      run_migrations:
        description: 'Run seed data migrations after schema deploy'
        required: false
        default: false
        type: boolean

permissions:
  id-token: write
  contents: read

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  # ============================================================================
  # Build Job - Build the DACPAC from .sqlproj
  # ============================================================================
  build:
    name: Build DACPAC
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Build SQL project
        run: dotnet build database/AccountingDB.sqlproj -c Release

      - name: Upload DACPAC
        uses: actions/upload-artifact@v4
        with:
          name: dacpac
          path: database/bin/Release/AccountingDB.dacpac
          retention-days: 5

  # ============================================================================
  # Deploy Job - Apply schema changes to production database
  # ============================================================================
  deploy:
    name: Deploy Schema
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            scripts
            database/migrations
            database/package.json
            database/package-lock.json

      - name: Download DACPAC
        uses: actions/download-artifact@v4
        with:
          name: dacpac

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Node.js
        if: ${{ !inputs.dry_run && inputs.run_migrations }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install SqlPackage
        run: dotnet tool install -g microsoft.sqlpackage

      - name: Retrieve connection string
        id: secrets
        run: |
          CONNECTION_STRING=$(az keyvault secret show \
            --vault-name kv2suhqabgprod \
            --name SqlConnectionString \
            --query value -o tsv)
          echo "::add-mask::$CONNECTION_STRING"
          echo "sql_connection_string=$CONNECTION_STRING" >> "$GITHUB_OUTPUT"

      - name: Generate diff script (dry run)
        if: ${{ inputs.dry_run }}
        run: |
          sqlpackage \
            /Action:Script \
            /SourceFile:AccountingDB.dacpac \
            /TargetConnectionString:"${{ steps.secrets.outputs.sql_connection_string }}" \
            /OutputPath:diff-script.sql \
            /p:BlockOnPossibleDataLoss=false \
            /p:GenerateSmartDefaults=true \
            /p:ScriptDatabaseOptions=false

          MAX_LINES=200
          HEAD_LINES=100
          TAIL_LINES=100

          if [ -f diff-script.sql ]; then
            TOTAL_LINES=$(wc -l < diff-script.sql || echo 0)

            {
              echo "### Database Schema Diff (Dry Run)"
              echo ""
              echo '```sql'
              if [ "$TOTAL_LINES" -le "$MAX_LINES" ]; then
                cat diff-script.sql
              else
                head -n "$HEAD_LINES" diff-script.sql
                echo ""
                echo "-- ... output truncated; showing first $HEAD_LINES and last $TAIL_LINES of $TOTAL_LINES lines ..."
                echo ""
                tail -n "$TAIL_LINES" diff-script.sql
              fi
              echo '```'
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### Database Schema Diff (Dry Run)" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "_No diff script was generated._" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload diff script artifact (dry run)
        if: ${{ inputs.dry_run }}
        uses: actions/upload-artifact@v4
        with:
          name: diff-script
          path: diff-script.sql
          retention-days: 5

      - name: Publish schema changes
        if: ${{ !inputs.dry_run }}
        run: |
          sqlpackage \
            /Action:Publish \
            /SourceFile:AccountingDB.dacpac \
            /TargetConnectionString:"${{ steps.secrets.outputs.sql_connection_string }}" \
            /p:BlockOnPossibleDataLoss=false \
            /p:GenerateSmartDefaults=true \
            /p:ScriptDatabaseOptions=false

          echo "### Database Schema Deployed" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Schema changes published successfully to **production**." >> "$GITHUB_STEP_SUMMARY"

      - name: Run migrations
        if: ${{ !inputs.dry_run && inputs.run_migrations }}
        env:
          SQL_CONNECTION_STRING: ${{ steps.secrets.outputs.sql_connection_string }}
        run: |
          echo "### Migration Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Find migration files and run them in order
          MIGRATION_DIR="database/migrations"
          if [ ! -d "$MIGRATION_DIR" ]; then
            echo "No migrations directory found, skipping." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          MIGRATIONS=$(ls "$MIGRATION_DIR"/*.sql 2>/dev/null | sort)
          if [ -z "$MIGRATIONS" ]; then
            echo "No migration files found." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          # Install pinned dependencies (including mssql) for migration runner
          (cd database && npm ci)

          for file in $MIGRATIONS; do
            BASENAME=$(basename "$file")
            echo "Running: $BASENAME"
            node scripts/run-prod-migration.js "$file"
            echo "- \`$BASENAME\` — completed" >> "$GITHUB_STEP_SUMMARY"
          done

      - name: Summary
        if: always()
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "| Parameter | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Environment | \`production\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Dry Run | \`${{ inputs.dry_run }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Run Migrations | \`${{ inputs.run_migrations }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Status | ${{ job.status == 'success' && '✅ Success' || '❌ Failed' }} |" >> "$GITHUB_STEP_SUMMARY"
