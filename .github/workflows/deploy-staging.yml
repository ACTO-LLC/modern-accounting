name: Deploy to Staging

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (not recommended)'
        required: false
        default: 'false'
        type: boolean
      environment:
        description: 'Target environment'
        required: false
        default: 'staging'
        type: choice
        options:
          - staging
          - uat

env:
  NODE_VERSION: '20'
  AZURE_WEBAPP_NAME: modern-accounting-staging
  AZURE_RESOURCE_GROUP: modern-accounting-rg

jobs:
  # ============================================================================
  # Test Job - Run all tests before deployment
  # ============================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_tests != 'true' }}

    services:
      # SQL Server for integration tests
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: Y
          MSSQL_SA_PASSWORD: TestPassword123
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P TestPassword123 -C -Q 'SELECT 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            chat-api/package-lock.json
            client/package-lock.json
            monitor-agent/package-lock.json

      # Install dependencies for all packages
      - name: Install chat-api dependencies
        run: npm ci
        working-directory: chat-api

      - name: Install client dependencies
        run: npm ci
        working-directory: client

      - name: Install monitor-agent dependencies
        run: npm ci
        working-directory: monitor-agent

      # Run tests
      - name: Run chat-api tests
        run: npm test
        working-directory: chat-api
        env:
          NODE_ENV: test
          DB_SERVER: localhost
          DB_PORT: 1433
          DB_USER: sa
          DB_PASSWORD: TestPassword123
          DB_NAME: AccountingDB_Test

      - name: Run monitor-agent tests
        run: npm test
        working-directory: monitor-agent
        env:
          NODE_ENV: test
          DB_SERVER: localhost
          DB_PORT: 1433
          DB_USER: sa
          DB_PASSWORD: TestPassword123
          DB_NAME: AccountingDB_Test

      # Upload test results
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            chat-api/coverage/
            monitor-agent/coverage/
          retention-days: 7

  # ============================================================================
  # Build Job - Build artifacts for deployment
  # ============================================================================
  build:
    name: Build Artifacts
    runs-on: ubuntu-latest
    needs: test
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install client dependencies
        run: npm ci
        working-directory: client

      - name: Build client
        run: npm run build
        working-directory: client
        env:
          VITE_API_URL: ${{ vars.STAGING_API_URL }}
          VITE_DAB_URL: ${{ vars.STAGING_DAB_URL }}

      - name: Upload client build artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-build
          path: client/dist/
          retention-days: 1

      - name: Package chat-api for deployment
        run: |
          mkdir -p deploy/chat-api
          cp -r chat-api/* deploy/chat-api/
          rm -rf deploy/chat-api/node_modules
          rm -rf deploy/chat-api/tests
          rm -f deploy/chat-api/vitest.config.js

      - name: Upload chat-api artifact
        uses: actions/upload-artifact@v4
        with:
          name: chat-api-build
          path: deploy/chat-api/
          retention-days: 1

  # ============================================================================
  # Deploy Job - Deploy to staging environment
  # ============================================================================
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: staging
      url: ${{ vars.STAGING_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            scripts
            database

      - name: Download client artifact
        uses: actions/download-artifact@v4
        with:
          name: client-build
          path: client-dist

      - name: Download chat-api artifact
        uses: actions/download-artifact@v4
        with:
          name: chat-api-build
          path: chat-api-dist

      # Database migration (placeholder)
      - name: Run database migrations
        run: |
          echo "Running database migrations..."
          echo "Placeholder: Would run migrations against staging database"
          # node scripts/deploy-db.js --env staging
        env:
          DB_SERVER: ${{ secrets.STAGING_DB_SERVER }}
          DB_USER: ${{ secrets.STAGING_DB_USER }}
          DB_PASSWORD: ${{ secrets.STAGING_DB_PASSWORD }}
          DB_NAME: ${{ secrets.STAGING_DB_NAME }}

      # PII Scrubbing for staging (if data was copied from prod)
      - name: Scrub PII data (staging only)
        if: ${{ github.event.inputs.environment == 'staging' || github.event.inputs.environment == '' }}
        run: |
          echo "Checking if PII scrubbing is needed..."
          echo "Placeholder: Would run scripts/scrub-pii.sql if fresh data copy"
          # This step runs the PII scrubbing script to anonymize sensitive data
          # in the staging environment after a production data refresh
        env:
          DB_SERVER: ${{ secrets.STAGING_DB_SERVER }}
          DB_USER: ${{ secrets.STAGING_DB_USER }}
          DB_PASSWORD: ${{ secrets.STAGING_DB_PASSWORD }}
          DB_NAME: ${{ secrets.STAGING_DB_NAME }}

      # Deploy to Azure App Service (placeholder)
      - name: Deploy chat-api to Azure
        run: |
          echo "Deploying chat-api to Azure App Service..."
          echo "Placeholder: Would deploy to ${{ env.AZURE_WEBAPP_NAME }}-api"
          # az webapp deploy --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          #   --name ${{ env.AZURE_WEBAPP_NAME }}-api \
          #   --src-path chat-api-dist
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy client to Azure Static Web Apps
        run: |
          echo "Deploying client to Azure Static Web Apps..."
          echo "Placeholder: Would deploy to ${{ env.AZURE_WEBAPP_NAME }}-client"
          # az staticwebapp upload --name ${{ env.AZURE_WEBAPP_NAME }}-client \
          #   --source client-dist
        env:
          AZURE_STATIC_WEB_APPS_API_TOKEN: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}

      # Health check (placeholder)
      - name: Verify deployment health
        run: |
          echo "Verifying deployment health..."
          echo "Placeholder: Would check ${{ vars.STAGING_API_URL }}/health"
          # curl -f ${{ vars.STAGING_API_URL }}/health || exit 1

      # Notify on deployment
      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "Deployment to staging successful!"
            # Could send Slack/Teams notification here
          else
            echo "Deployment to staging failed!"
          fi

  # ============================================================================
  # Smoke Tests Job - Run smoke tests after deployment
  # ============================================================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            client/tests

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run smoke tests
        run: |
          echo "Running smoke tests against staging environment..."
          echo "Placeholder: Would run Playwright tests against staging"
          # npx playwright test --project=staging
        env:
          STAGING_URL: ${{ vars.STAGING_URL }}
          STAGING_API_URL: ${{ vars.STAGING_API_URL }}

      - name: Report smoke test results
        if: always()
        run: |
          echo "Smoke tests completed with status: ${{ job.status }}"
