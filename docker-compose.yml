version: '3.8'

# Local development without Dev Containers
# For isolated environments, use .devcontainer instead

services:
  database:
    image: mcr.microsoft.com/azure-sql-edge:latest
    container_name: accounting-db
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=${SQL_SA_PASSWORD:-StrongPassword123!}
    ports:
      - "14330:1433"
    volumes:
      - sql-data:/var/opt/mssql

  dab:
    image: mcr.microsoft.com/azure-databases/data-api-builder:1.7.81-rc
    container_name: accounting-dab
    depends_on:
      - database
    ports:
      - "5000:5000"
    volumes:
      - ./dab-config.json:/App/dab-config.json
    environment:
      - DAB_CONNECTION_STRING=Server=database,1433;Database=AccountingDB;User Id=sa;Password=${SQL_SA_PASSWORD:-StrongPassword123!};TrustServerCertificate=true

  qbo-mcp:
    build:
      context: ./qbo-mcp-http-server
      dockerfile: Dockerfile
    container_name: accounting-qbo-mcp
    ports:
      - "8001:8001"
    environment:
      - QBO_MCP_PORT=8001
      - QBO_ENVIRONMENT=${QBO_ENVIRONMENT:-sandbox}
      - QBO_CLIENT_ID=${QBO_CLIENT_ID}
      - QBO_CLIENT_SECRET=${QBO_CLIENT_SECRET}
      - QBO_REDIRECT_URI=${QBO_REDIRECT_URI:-http://localhost:8001/oauth/callback}

  ma-mcp:
    build:
      context: ./ma-mcp-server
      dockerfile: Dockerfile
    container_name: accounting-ma-mcp
    depends_on:
      - database
    ports:
      - "5002:5002"
    environment:
      - MA_MCP_PORT=5002
      - DB_SERVER=database,1433
      - DB_NAME=AccountingDB
      - DB_USER=sa
      - DB_PASSWORD=${SQL_SA_PASSWORD:-StrongPassword123!}
      - DB_TRUST_CERT=true

  email-api:
    build:
      context: ./email-api
      dockerfile: Dockerfile
    container_name: accounting-email-api
    depends_on:
      - database
    ports:
      - "7073:7073"
    environment:
      - DATABASE_URL=Server=database,1433;Database=AccountingDB;User Id=sa;Password=StrongPassword123!;TrustServerCertificate=true
      - EMAIL_API_PORT=7073
      - EMAIL_ENCRYPTION_KEY=${EMAIL_ENCRYPTION_KEY:-default-encryption-key-change-me}
      - APP_BASE_URL=http://host.docker.internal:5173
      - DAB_API_URL=http://dab:5000/api
    volumes:
      - ./email-api:/app
      - /app/node_modules

  # Monitor Agent - AI-driven enhancement processor
  # Not started by default - enable with: docker compose --profile agent up
  monitor-agent:
    build:
      context: ./monitor-agent
      dockerfile: Dockerfile
    container_name: accounting-monitor-agent
    profiles:
      - agent
    depends_on:
      - database
    environment:
      - DB_SERVER=database
      - DB_PORT=1433
      - DB_NAME=AccountingDB
      - DB_USER=sa
      - DB_PASSWORD=${SQL_SA_PASSWORD:-StrongPassword123!}
      - DB_TRUST_CERT=true
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_OWNER=${GITHUB_OWNER:-modern-accounting}
      - GITHUB_REPO=${GITHUB_REPO:-modern-accounting}
      - GITHUB_BASE_BRANCH=${GITHUB_BASE_BRANCH:-main}
      - GIT_REPO_PATH=/repo
      - GIT_AUTHOR_NAME=Monitor Agent
      - GIT_AUTHOR_EMAIL=agent@modern-accounting.local
      - POLL_INTERVAL_MS=${POLL_INTERVAL_MS:-300000}
      - MAX_CONCURRENT_JOBS=${MAX_CONCURRENT_JOBS:-1}
      - ENABLE_EMAIL_NOTIFICATIONS=${ENABLE_EMAIL_NOTIFICATIONS:-false}
      - ENABLE_SLACK_NOTIFICATIONS=${ENABLE_SLACK_NOTIFICATIONS:-false}
      - DRY_RUN=${DRY_RUN:-false}
    volumes:
      - .:/repo:rw

volumes:
  sql-data:
    external: true
    name: modern-accounting-bank-feeds_sql-data
